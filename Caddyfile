# global options
{
	admin off # theres no need for the admin api in railway's environment
	persist_config off # storage isn't persistent anyway
	auto_https off # railway handles https for us, this could in some cases cause issues if left enabled
	# runtime logs
	log {
		format json # set runtime log format to json mode 
	}
	# server options
	servers {
		trusted_proxies static private_ranges 100.0.0.0/8 # trust railway's proxy
	}
}

# site block, listens on the $PORT environment variable, automatically assigned by railway
:{$PORT} {
	# access logs
	log {
		format json # set access log format to json mode
	}

	# keep your working catch-all exactly as-is
	reverse_proxy /* {$WEB_ENDPOINT} {
		header_up Host {upstream_hostport}
	}

	handle /god-mode/* {
		reverse_proxy {$ADMIN_ENDPOINT} {
			header_up Host {upstream_hostport}
		}
	}

	# --- ONLY CHANGE: forward real host/proto to API so OAuth builds public URLs ---
	handle /api/* {
	  reverse_proxy {$API_ENDPOINT} {
	    header_up Host {http.request.host}
	    header_up X-Forwarded-Host {http.request.host}
	    header_up X-Forwarded-Proto {http.request.scheme}
	    header_up X-Forwarded-Port 443
	    header_up X-Real-IP {remote}
	
	    # NEW: prefer IPv4 so Caddy dials 0.0.0.0:8000, not [fd12:...]:8000
	    transport http {
	      resolve_preference ipv4
	    }
	  }
	}
	
	handle /auth/* {
	  reverse_proxy {$API_ENDPOINT} {
	    header_up Host {http.request.host}
	    header_up X-Forwarded-Host {http.request.host}
	    header_up X-Forwarded-Proto {http.request.scheme}
	    header_up X-Forwarded-Port 443
	    header_up X-Real-IP {remote}
	
	    # NEW
	    transport http {
	      resolve_preference ipv4
	    }
	  }
	}


	handle /spaces/* {
		reverse_proxy {$SPACES_ENDPOINT} {
			header_up Host {upstream_hostport}
		}
	}

	handle /{$BUCKET_NAME}/* {
		reverse_proxy {$BUCKET_ENDPOINT} {
			header_up Host {upstream_hostport}
		}
	}
}
